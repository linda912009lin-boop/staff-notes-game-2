<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>音符數獨</title>
<style>
  :root{
    --board-size: 640px;           /* 棋盤總寬高 */
    --cell: calc(var(--board-size)/9);
    --choice-size: 44px;           /* 彈出答案選項小圖尺寸 ✅你要的縮小 */
    --tray-size: 58px;             /* 右下卡牌尺寸 */
    --brand: #111;
    --muted: #777;
    --ui: #f6f7f9;
    --ok: #2e7d32;
    --warn:#ef5350;
    --card: #fff;
    --shadow: 0 10px 30px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:#fff; color:#222; font:16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial;
  }
  header{display:flex; justify-content:center; gap:.75rem; align-items:center; padding:18px 12px 6px}
  h1{margin:0; font-weight:800; letter-spacing:.1em}
  .wrap{display:grid; grid-template-columns: 1fr 360px; gap:28px; max-width:1200px; margin:0 auto; padding:0 20px 60px}
  .stage{position:relative; display:flex; justify-content:center}
  /* 棋盤 */
  .board{
    position:relative; width:var(--board-size); height:var(--board-size);
    background:#fff; border:3px solid #000; box-shadow: var(--shadow);
  }
  .row{display:flex}
  .cell{
    width:var(--cell); height:var(--cell); border:1px solid #2222;
    display:flex; align-items:center; justify-content:center; background:#fff; position:relative;
  }
  /* 粗線 3x3 */
  .cell[data-r="2"], .cell[data-r="5"]{border-bottom:3px solid #000}
  .cell[data-c="2"], .cell[data-c="5"]{border-right:3px solid #000}
  .cell img{max-width:85%; max-height:85%; pointer-events:none; user-select:none}
  .cell.drop-hover{outline:3px dashed #4a90e2; outline-offset:-3px}

  /* 右側控制卡 */
  .panel{background:#fff; border-radius:14px; padding:16px; box-shadow: var(--shadow); align-self:flex-start}
  .panel h3{margin:0 0 8px; font-size:18px}
  .rowline{display:flex; align-items:center; gap:8px; margin:10px 0}
  .panel label{font-size:14px; color:#444}
  .muted{color:var(--muted); font-size:13px}
  button, .btn{
    appearance:none; border:1px solid #0002; background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;
    transition:.15s transform;
  }
  button:hover{transform:translateY(-1px)}
  button.primary{background:#111; color:#fff; border-color:#111}
  button.green{background: var(--ok); color:#fff; border-color:var(--ok)}
  button.ghost{background:#fff}
  .flex{display:flex; gap:8px; flex-wrap:wrap}

  /* 開始說明 Modal */
  .modal-mask{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50}
  .modal{width:min(820px,92vw); background:#fff; border-radius:16px; padding:20px; box-shadow: var(--shadow)}
  .modal h2{margin:0 0 8px}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .choice{border:2px solid #000; border-radius:12px; padding:10px; text-align:center; cursor:pointer}
  .choice[aria-selected="true"]{background:#000; color:#fff}

  /* 答案彈出選單（縮小版） */
  .answer-pop{
    position:absolute; z-index:40; background:#fff; border:2px solid #000; border-radius:12px;
    padding:8px; display:none; gap:6px; box-shadow: var(--shadow); align-items:center;
  }
  .answer-pop .note{width:var(--choice-size); height:var(--choice-size); display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:8px; border:1px solid #0001; background:#fff}
  .answer-pop .note:hover{outline:2px solid #4a90e2}
  .answer-pop img{max-width:90%; max-height:90%; pointer-events:none}

  /* 右下卡牌托盤（你要的） */
  .tray{
    position:absolute; right:-10px; bottom:-10px; display:flex; gap:10px; padding:10px 12px; background:#fff; border:2px solid #000;
    border-radius:12px; box-shadow: var(--shadow); flex-wrap:wrap; max-width:calc(100% + 200px);
  }
  .card{
    width:var(--tray-size); height:var(--tray-size); background:#fff; border:1px solid #0002; border-radius:10px;
    display:flex; align-items:center; justify-content:center; cursor:grab;
  }
  .card img{max-width:92%; max-height:92%; pointer-events:none; user-select:none}
  .sr-only{position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap}

  footer{max-width:1200px; margin:14px auto 22px; padding:0 20px; color:#333; font-size:13px}
  footer a{color:#0366d6}
</style>
</head>
<body>

<header>
  <h1>音符數獨</h1>
</header>

<div class="wrap">
  <!-- 棋盤與托盤 -->
  <div class="stage">
    <div class="board" id="board" aria-label="9x9 數獨棋盤"></div>

    <!-- 右下卡牌托盤（可拖曳） -->
    <div class="tray" id="tray" aria-label="音符卡牌托盤"></div>

    <!-- 答案彈出選單（點空格跳出） -->
    <div class="answer-pop" id="answerPop" role="menu" aria-label="答案選項"></div>
  </div>

  <!-- 右側控制面板 -->
  <aside class="panel">
    <h3>設定</h3>

    <div class="rowline">
      <label for="diff">困難度（挖空格數）</label>
      <input id="diff" type="range" min="0" max="40" value="32" />
      <span class="muted" id="diffLbl">32 格</span>
    </div>

    <div class="rowline">
      <label>時間</label>
      <div class="flex">
        <button id="btnNew">新題目</button>
        <button id="btnRestart">重新開始</button>
        <span class="muted" id="timer">00:00</span>
      </div>
    </div>

    <div class="rowline">
      <label>音量</label>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.5"/>
      <div class="flex">
        <button id="muteBtn" class="ghost">🔇 靜音/取消</button>
      </div>
    </div>

    <div class="rowline">
      <label class="muted">模式：</label><span class="muted" id="modeTxt">高音區域</span>
    </div>

    <div class="rowline">
      <button id="finishBtn" class="green">已完成填寫</button>
    </div>
  </aside>
</div>

<!-- 開局說明 + 區域選擇 -->
<div class="modal-mask" id="startMask" aria-modal="true" role="dialog">
  <div class="modal">
    <h2>開始前說明</h2>
    <p class="muted">點空白格可跳出答案選項；也可把右下托盤的卡牌拖到空格中。<br>移動「困難度」可調整挖空格數（0 代表顯示完整答案）。按「開始遊戲」後會開始計時。</p>
    <label class="muted">選擇音域</label>
    <div class="grid2" style="margin:10px 0 6px">
      <div class="choice" id="pickHigh" tabindex="0" aria-selected="true">高音區域（高音譜記號～高音 DO）</div>
      <div class="choice" id="pickLow"  tabindex="0" aria-selected="false">低音區域（低音譜記號～中央 DO）</div>
    </div>
    <div style="text-align:right; margin-top:10px">
      <button id="startBtn" class="primary">開始遊戲</button>
    </div>
  </div>
</div>

<!-- BGM -->
<audio id="bgm" src="audio/bgm.mp3" loop autoplay></audio>

<footer>
  Music: "<strong>Danse Morialta</strong>" Kevin MacLeod (incompetech.com) · Licensed under Creative Commons:
  <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">By Attribution 4.0 License</a>
</footer>

<script>
/* ------------------ 資料：圖片對應（請確保 assets 內檔名一致） ------------------ */
/* 順序皆以 1..9 對應 */
const NOTE_SETS = {
  high: [
    "高音譜號.png",              // 1
    "高音譜號下加一線do五線譜.png", // 2
    "高音譜號下一間re五線譜.png",   // 3
    "高音譜號第一線mi五線譜.png",   // 4
    "高音譜號第一間fa五線譜.png",   // 5
    "高音譜號第二線sol五線譜.png",  // 6
    "高音譜號第二間la五線譜.png",   // 7
    "高音譜號第三線si五線譜.png",   // 8
    "高音譜號第三間do五線譜.png"    // 9
  ],
  low: [
    "低音譜號.png",                 // 1
    "低音譜號上加一線do五線譜.png",   // 2  （先前你提過和「第二間do」對調，這份已採用新順序）
    "低音譜號上加一間si五線譜.png",   // 3
    "低音譜號第三線re五線譜.png",     // 4
    "低音譜號第三間mi五線譜.png",     // 5
    "低音譜號第四線fa五線譜.png",     // 6
    "低音譜號第四間sol五線譜.png",    // 7
    "低音譜號第五線la五線譜.png",     // 8
    "低音譜號第二間do五線譜.png"      // 9
  ]
};

const ASSET = n => `assets/${n}`;

/* ------------------ 基礎 Sudoku：一個標準解 + 打亂生成 ------------------ */
const baseSolved = [
  [1,2,3, 4,5,6, 7,8,9],
  [4,5,6, 7,8,9, 1,2,3],
  [7,8,9, 1,2,3, 4,5,6],

  [2,3,4, 5,6,7, 8,9,1],
  [5,6,7, 8,9,1, 2,3,4],
  [8,9,1, 2,3,4, 5,6,7],

  [3,4,5, 6,7,8, 9,1,2],
  [6,7,8, 9,1,2, 3,4,5],
  [9,1,2, 3,4,5, 6,7,8],
];

function deepCopy(m){return m.map(r=>r.slice());}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=(Math.random()* (i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a;}
function permuteNumbers(grid){
  // 隨機映射 1..9
  const map = shuffle([1,2,3,4,5,6,7,8,9]);
  return grid.map(row=>row.map(v=>map[v-1]));
}
function swapRowsBands(g){
  // 在每個 band(3列) 內對調列
  let grid = deepCopy(g);
  for(let b=0;b<3;b++){
    const rows=[0,1,2].map(i=>b*3+i);
    shuffle(rows);
    const copy=rows.map(i=>grid[i]);
    for(let i=0;i<3;i++) grid[b*3+i]=copy[i];
  }
  return grid;
}
function swapColsBands(g){
  let grid = deepCopy(g);
  for(let b=0;b<3;b++){
    const cols=[0,1,2].map(i=>b*3+i);
    shuffle(cols);
    // 交換欄
    const dup = grid.map(row => cols.map(c=>row[c]));
    for(let r=0;r<9;r++) for(let i=0;i<3;i++) grid[r][b*3+i]=dup[r][i];
  }
  return grid;
}
function rotate(g){
  // 旋轉或轉置
  const type = Math.floor(Math.random()*4); // 0..3
  let grid = deepCopy(g);
  if(type===1){ // transpose
    grid = grid.map((_,i)=>grid.map(r=>r[i]));
  }else if(type===2){ // rotate 90
    grid = grid.map((_, r)=>grid.map(row=>row[r]).reverse());
  }else if(type===3){ // rotate 270
    grid = grid.map((_, r)=>grid.map(row=>row[8-r]));
  }
  return grid;
}
function genSolved(){
  let g=deepCopy(baseSolved);
  g = permuteNumbers(g);
  g = swapRowsBands(g);
  g = swapColsBands(g);
  g = rotate(g);
  return g;
}
function makePuzzle(solved, holes){
  const puzzle=deepCopy(solved);
  const idx=[...Array(81)].map((_,i)=>i);
  shuffle(idx);
  for(let i=0;i<Math.min(holes,81);i++){
    const k=idx[i];
    const r=(k/9)|0, c=k%9;
    puzzle[r][c]=0;
  }
  return puzzle;
}

/* ------------------ DOM 與狀態 ------------------ */
const boardEl = document.getElementById('board');
const trayEl  = document.getElementById('tray');
const popEl   = document.getElementById('answerPop');
const diffEl  = document.getElementById('diff');
const diffLbl = document.getElementById('diffLbl');
const timerEl = document.getElementById('timer');
const btnNew  = document.getElementById('btnNew');
const btnRestart = document.getElementById('btnRestart');
const finishBtn  = document.getElementById('finishBtn');
const maskEl  = document.getElementById('startMask');
const pickHigh= document.getElementById('pickHigh');
const pickLow = document.getElementById('pickLow');
const startBtn= document.getElementById('startBtn');
const modeTxt = document.getElementById('modeTxt');
const bgm     = document.getElementById('bgm');
const volEl   = document.getElementById('vol');
const muteBtn = document.getElementById('muteBtn');

let mode = 'high';                   // 'high' | 'low'
let solved = genSolved();
let puzzle  = makePuzzle(solved, +diffEl.value);
let user    = deepCopy(puzzle);
let running = false, t0=0, tick=null;

// 建盤
function buildBoard(){
  boardEl.innerHTML='';
  for(let r=0;r<9;r++){
    const row = document.createElement('div'); row.className='row';
    for(let c=0;c<9;c++){
      const cell = document.createElement('div'); cell.className='cell';
      cell.dataset.r=r; cell.dataset.c=c;
      if(r%3===2) cell.setAttribute('data-r','2');
      if(c%3===2) cell.setAttribute('data-c','2');

      // 初始題目/使用者
      const v = user[r][c];
      if(v>0) cell.appendChild(noteImg(v));

      // 點擊：開啟彈出選單
      cell.addEventListener('click', (e)=>{
        showChoicesAt(cell, r, c);
      });

      // DnD 放置
      cell.addEventListener('dragover', (e)=>{e.preventDefault(); cell.classList.add('drop-hover');});
      cell.addEventListener('dragleave', ()=>cell.classList.remove('drop-hover'));
      cell.addEventListener('drop', (e)=>{
        e.preventDefault(); cell.classList.remove('drop-hover');
        const v = +e.dataTransfer.getData('text/plain');
        place(r,c,v);
      });

      row.appendChild(cell);
    }
    boardEl.appendChild(row);
  }
}
function noteImg(v){
  const img = document.createElement('img');
  img.alt = `數字 ${v}`;
  img.src = ASSET(NOTE_SETS[mode][v-1]);
  return img;
}

// 彈出答案（縮小版）
function showChoicesAt(cell, r, c){
  popEl.innerHTML='';
  for(let v=1; v<=9; v++){
    const btn = document.createElement('div');
    btn.className='note';
    const img = document.createElement('img');
    img.src = ASSET(NOTE_SETS[mode][v-1]);
    img.alt = `選 ${v}`;
    btn.appendChild(img);
    btn.addEventListener('click', ()=>{ place(r,c,v); hidePop(); });
    popEl.appendChild(btn);
  }
  const rect = cell.getBoundingClientRect();
  const host = boardEl.getBoundingClientRect();
  popEl.style.left = (rect.left - host.left + rect.width + 8) + 'px';
  popEl.style.top  = (rect.top  - host.top ) + 'px';
  popEl.style.display='flex';
}
function hidePop(){ popEl.style.display='none'; }

// 放入
function place(r,c,v){
  user[r][c]=v;
  const cell = boardEl.children[r].children[c];
  cell.innerHTML=''; cell.appendChild(noteImg(v));
}

// 托盤
function buildTray(){
  trayEl.innerHTML='';
  for(let v=1; v<=9; v++){
    const card = document.createElement('div'); card.className='card'; card.draggable=true;
    card.title = `拖曳數字 ${v}`;
    const img = document.createElement('img'); img.src=ASSET(NOTE_SETS[mode][v-1]); img.alt=`${v}`;
    card.appendChild(img);
    card.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('text/plain', String(v));
    });
    trayEl.appendChild(card);
  }
}

/* 生成新題目 / 重新開始 */
function startTimer(){
  clearInterval(tick);
  t0 = Date.now();
  tick = setInterval(()=>{
    const s = Math.floor((Date.now()-t0)/1000);
    const mm = String((s/60|0)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    timerEl.textContent = `${mm}:${ss}`;
  }, 1000);
}
function newGame(){
  hidePop();
  solved = genSolved();
  puzzle = makePuzzle(solved, +diffEl.value);
  user   = deepCopy(puzzle);
  buildBoard();
  buildTray();
  startTimer();
  running = true;
}
function restart(){
  hidePop();
  user = deepCopy(puzzle);
  buildBoard();
  startTimer();
  running = true;
}

/* 完成檢查 */
function checkFinish(){
  // 若尚有 0（空），提示先填完
  for(let r=0;r<9;r++) for(let c=0;c<9;c++){
    if(user[r][c]===0){ alert('還有空格尚未填寫喔！'); return; }
  }
  // 計分
  let ok=0, total=81;
  for(let r=0;r<9;r++) for(let c=0;c<9;c++){
    if(user[r][c]===solved[r][c]) ok++;
  }
  if(ok===total){
    alert('🎉 全部正確！太厲害了！');
  }else{
    alert(`已完成填寫！\n正確：${ok} / ${total}`);
  }
}

/* UI 綁定 */
diffEl.addEventListener('input', ()=>{
  diffLbl.textContent = `${diffEl.value} 格`;
});
btnNew.addEventListener('click', newGame);
btnRestart.addEventListener('click', restart);
finishBtn.addEventListener('click', checkFinish);

/* 模式選擇（可從開局選，遊戲中可再次呼叫 modal 變更模式—保留狀態但會以新圖集重繪） */
function setMode(m){
  mode=m;
  modeTxt.textContent = m==='high' ? '高音區域' : '低音區域';
  buildBoard();   // 只重畫圖示
  buildTray();
}
pickHigh.addEventListener('click', ()=>{
  pickHigh.setAttribute('aria-selected','true');
  pickLow.setAttribute('aria-selected','false');
  setMode('high');
});
pickLow.addEventListener('click', ()=>{
  pickLow.setAttribute('aria-selected','true');
  pickHigh.setAttribute('aria-selected','false');
  setMode('low');
});
startBtn.addEventListener('click', ()=>{
  maskEl.style.display='none';
  newGame();
});

/* 音量/靜音 */
volEl.addEventListener('input', ()=>{ bgm.volume = +volEl.value; });
muteBtn.addEventListener('click', ()=>{
  bgm.muted = !bgm.muted;
  muteBtn.textContent = bgm.muted ? '🔈 取消靜音' : '🔇 靜音/取消';
});

/* 點其他處關閉彈出 */
document.addEventListener('click', (e)=>{
  const isCell=e.target.closest?.('.cell');
  const isPop =e.target.closest?.('.answer-pop');
  if(!isCell && !isPop) hidePop();
});

/* 初始：顯示說明與選擇音域（並自動嘗試播放 BGM；若瀏覽器限制，使用者互動後才會響） */
function boot(){
  // 初始化音量
  bgm.volume = +volEl.value;
  maskEl.style.display='flex';
  // 先建空盤與托盤（預設高音域）
  setMode('high');
  buildBoard();
  buildTray();
}
boot();
</script>
</body>
</html>
