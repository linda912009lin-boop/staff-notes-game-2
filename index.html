<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>éŸ³ç¬¦æ•¸ç¨</title>
<style>
  :root{
    --board-size: 78vmin;        /* æ£‹ç›¤é‚Šé•· */
    --gap: 16px;                  /* å€å¡Šé–“é–“è· */
    --sidebar-w: 340px;           /* å³å´è¨­å®šå¯¬åº¦ */
    --palette-w: 140px;           /* ä¸­é–“ç­”æ¡ˆæ¬„å¯¬åº¦ï¼ˆä½ è¦çš„ä½ç½®ï¼‰ */
    --cell: calc(var(--board-size)/9);
    --bold: 4px;
    --thin: 1.5px;
    --ui-bg: #fff;
    --ui-shadow: 0 8px 24px rgba(0,0,0,.12);
  }

  body{
    margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
    background:#fafafa; color:#111; 
  }

  header{ text-align:center; padding:18px 12px 8px; font-weight:800; font-size: clamp(22px, 2.6vmin, 32px);}
  .page{
    display:grid;
    grid-template-columns: var(--board-size) var(--palette-w) var(--sidebar-w);
    justify-content:center;
    column-gap: var(--gap);
    row-gap: var(--gap);
    padding: 0 clamp(8px, 2vmin, 24px) 28px;
  }

  /* æ£‹ç›¤ */
  .board{
    width: var(--board-size);
    height: var(--board-size);
    background:#fff;
    box-shadow: var(--ui-shadow);
    border: var(--bold) solid #111;
    position:relative;
  }
  .grid{
    position:absolute; inset:0; display:grid;
    grid-template-columns: repeat(9, 1fr);
    grid-template-rows: repeat(9, 1fr);
  }
  .cell{
    border: var(--thin) solid #111;
    position:relative; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
    background:#fff;
  }
  /* ä¹å®®æ ¼ç²—ç·š */
  .cell:nth-child(3n+1){ /* å·¦ç²—ç·šæ¯åˆ—ç¬¬ä¸€æ ¼å¦å¤–è™•ç†åœ¨å®¹å™¨ */ }
  .grid > :nth-child(9n+1){ border-left: var(--bold) solid #111; }
  .grid > :nth-child(-n+9){ border-top: var(--bold) solid #111; }
  .grid > :nth-child(9n){ border-right: var(--bold) solid #111; }
  .grid > :nth-last-child(-n+9){ border-bottom: var(--bold) solid #111; }
  .grid > :nth-child(3n){ border-right: var(--bold) solid #111; }
  .grid > :nth-child(n+19):nth-child(-n+27),
  .grid > :nth-child(n+46):nth-child(-n+54){ border-bottom: var(--bold) solid #111; }

  .cell img{ width: 92%; height:auto; object-fit:contain; pointer-events:none; }

  /* ä¸­é–“ç­”æ¡ˆæ¬„ï¼ˆä½ æŒ‡å®šçš„ä½ç½®ï¼‰ */
  .palette{
    width: var(--palette-w);
    height: var(--board-size);
    align-self:start;
    background: var(--ui-bg);
    box-shadow: var(--ui-shadow);
    border-radius: 12px;
    padding:10px;
    display:flex; flex-direction:column; gap:10px;
    overflow:auto;
  }
  .choice{
    background:#fff; border:1.5px solid #111; border-radius:10px;
    padding:6px; display:flex; align-items:center; justify-content:center;
    cursor:pointer; transition: transform .06s ease;
    aspect-ratio: 1 / 1;
  }
  .choice:hover{ transform: translateY(-1px); }
  .choice img{ width: 100%; height:auto; object-fit:contain; }

  /* å³å´è¨­å®šå¡ */
  .panel{
    width: var(--sidebar-w);
    background:var(--ui-bg);
    box-shadow: var(--ui-shadow);
    border-radius:14px; padding:18px 18px;
    align-self:start;
  }
  .panel h3{ margin:0 0 10px; font-size:18px;}
  .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:12px 0;}
  .panel button, .panel select{
    border:1px solid #ddd; background:#fff; border-radius:8px; padding:8px 10px; cursor:pointer;
  }
  .panel button.primary{ background:#28a745; color:#fff; border:0; }
  .muted{ opacity:.6}
  .note{ font-size:12px; color:#666; text-align:center; margin-top:12px; }

  /* é¸æ“‡æ ¼é«˜äº® */
  .cell.sel{ outline: 3px solid #3b82f6; outline-offset:-3px; }

  /* åº•éƒ¨ç½²å */
  footer{ text-align:center; font-size:12px; color:#555; margin-top:8px; }
  footer a{ color:#1d4ed8; text-decoration:none; }

  /* å°è¢å¹•ï¼šæŠŠ palette æ”¶åˆ°æ£‹ç›¤ä¸‹æ–¹ï¼ˆä»ä¸é®ä½æ£‹ç›¤ï¼‰ */
  @media (max-width: 1024px){
    :root{ --sidebar-w: 310px; --palette-w: 118px; }
    .page{ grid-template-columns: minmax(290px, var(--board-size)) var(--palette-w) var(--sidebar-w); }
  }
  @media (max-width: 860px){
    :root{ --board-size: 92vmin; }
    .page{ grid-template-columns: 1fr; }
    .palette, .panel{ width: min(560px, 94%); justify-self:center; }
    .palette{ height: auto; max-height: 36vh; order: 2; }
    .panel{ order:3; }
    .board{ justify-self:center; order:1; }
  }
</style>
</head>
<body>

<header>éŸ³ç¬¦æ•¸ç¨</header>

<main class="page">
  <!-- æ£‹ç›¤ -->
  <section class="board" id="board">
    <div class="grid" id="grid"></div>
  </section>

  <!-- ä¸­é–“ç­”æ¡ˆæ¬„ï¼ˆä½æ–¼æ£‹ç›¤èˆ‡è¨­å®šä¸­é–“ï¼‰ -->
  <aside class="palette" id="palette"></aside>

  <!-- è¨­å®šé¢æ¿ -->
  <aside class="panel">
    <h3>è¨­å®š</h3>

    <div class="row">
      <span>å›°é›£åº¦ï¼ˆæŒ–ç©ºæ ¼æ•¸ï¼‰</span>
      <input id="holes" type="range" min="0" max="40" value="32" />
      <span id="holesVal">32 æ ¼</span>
    </div>

    <div class="row">
      <span>æ™‚é–“</span>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="newBtn">æ–°é¡Œç›®</button>
        <button id="restartBtn">é‡æ–°é–‹å§‹</button>
        <span id="time">00:00</span>
      </div>
    </div>

    <div class="row">
      <span>éŸ³é‡</span>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.5" />
        <button id="muteBtn">ğŸ”‡ éœéŸ³/å–æ¶ˆ</button>
      </div>
    </div>

    <div class="row">
      <span>æ¨¡å¼ï¼š</span>
      <select id="mode">
        <option value="treble">é«˜éŸ³å€åŸŸ</option>
        <option value="bass">ä½éŸ³å€åŸŸ</option>
      </select>
    </div>

    <div class="row">
      <button id="checkBtn" class="primary">å·²å®Œæˆå¡«å¯«</button>
    </div>
    <div class="note">å®Œæˆå¾Œå¯æª¢æŸ¥ï¼Œæ­£ç¢ºæœƒæ­¡å‘¼ï¼</div>
  </aside>
</main>

<footer>
  Music: "Danse Morialta" Kevin MacLeod (incompetech.com) Â· Licensed under Creative Commons: By Attribution 4.0 License Â·
  <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">http://creativecommons.org/licenses/by/4.0/</a>
</footer>

<audio id="bgm" src="audio/bgm.mp3" preload="auto" loop autoplay></audio>

<script>
/* ---------------- è³‡æ–™ï¼šå½±åƒæ¸…å–®ï¼ˆä¾ä½ è¦æ±‚çš„é †åºï¼‰ ---------------- */
const IMAGES = {
  treble: [
    {key:'c_low',  src:'assets/é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šdoäº”ç·šè­œ.png', label:'ä¸‹åŠ ä¸€ç·šdo'},
    {key:'d',      src:'assets/é«˜éŸ³è­œè™Ÿä¸‹ä¸€é–“reäº”ç·šè­œ.png',   label:'re'},
    {key:'e',      src:'assets/é«˜éŸ³è­œè™Ÿç¬¬ä¸€ç·šmiäº”ç·šè­œ.png',   label:'mi'},
    {key:'f',      src:'assets/é«˜éŸ³è­œè™Ÿç¬¬ä¸€é–“faäº”ç·šè­œ.png',   label:'fa'},
    {key:'g',      src:'assets/é«˜éŸ³è­œè™Ÿç¬¬äºŒç·šsoläº”ç·šè­œ.png',  label:'sol'},
    {key:'a',      src:'assets/é«˜éŸ³è­œè™Ÿç¬¬äºŒé–“laäº”ç·šè­œ.png',   label:'la'},
    {key:'b',      src:'assets/é«˜éŸ³è­œè™Ÿç¬¬ä¸‰ç·šsiäº”ç·šè­œ.png',   label:'si'},
    {key:'c_hi',   src:'assets/é«˜éŸ³è­œè™Ÿç¬¬ä¸‰é–“doäº”ç·šè­œ.png',   label:'ç¬¬ä¸‰é–“do'}
  ],
  bass: [
    {key:'c',      src:'assets/ä½éŸ³è­œè™Ÿç¬¬äºŒé–“doäº”ç·šè­œ.png',   label:'ç¬¬äºŒé–“do'},
    {key:'d',      src:'assets/ä½éŸ³è­œè™Ÿç¬¬ä¸‰ç·šreäº”ç·šè­œ.png',   label:'re'},
    {key:'e',      src:'assets/ä½éŸ³è­œè™Ÿç¬¬ä¸‰é–“miäº”ç·šè­œ.png',   label:'mi'},
    {key:'f',      src:'assets/ä½éŸ³è­œè™Ÿç¬¬å››ç·šfaäº”ç·šè­œ.png',   label:'fa'},
    {key:'g',      src:'assets/ä½éŸ³è­œè™Ÿç¬¬å››é–“soläº”ç·šè­œ.png',  label:'sol'},
    {key:'a',      src:'assets/ä½éŸ³è­œè™Ÿç¬¬äº”ç·šlaäº”ç·šè­œ.png',   label:'la'},
    {key:'b',      src:'assets/ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“siäº”ç·šè­œ.png', label:'si'},
    {key:'c_up',   src:'assets/ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šdoäº”ç·šè­œ.png', label:'ä¸ŠåŠ ä¸€ç·šdo'}
  ]
};
// ç‰ˆé¢ä¸Šå›ºå®šé¡¯ç¤ºè­œè™Ÿä½œç‚ºç¬¬ä¸€å¼µï¼ˆéå¯å¡«å…¥çš„ç­”æ¡ˆï¼‰
const CLEF_IMG = {
  treble: 'assets/é«˜éŸ³è­œè™Ÿ.png',
  bass:   'assets/ä½éŸ³è­œè™Ÿ.png'
};

/* ---------------- æ£‹ç›¤/é¡Œç›®ï¼ˆç°¡åŒ–ç¯„ä¾‹ï¼šè—æœ¬è§£ + æŒ–ç©ºï¼‰ ---------------- */
// å›ºå®šè§£ï¼ˆ9x9 1..9ï¼‰ï¼›ä½ å¯æ›æˆè‡ªå·±çš„é¡Œåº«ç”¢ç”Ÿå™¨
const SOLVE = [
  [5,3,4,6,7,8,9,1,2],
  [6,7,2,1,9,5,3,4,8],
  [1,9,8,3,4,2,5,6,7],
  [8,5,9,7,6,1,4,2,3],
  [4,2,6,8,5,3,7,9,1],
  [7,1,3,9,2,4,8,5,6],
  [9,6,1,5,3,7,2,8,4],
  [2,8,7,4,1,9,6,3,5],
  [3,4,5,2,8,6,1,7,9]
];
let puzzle = [];
let mode = 'treble';
let startMS = 0, timerId = null;
let selectedCell = null;

const gridEl = document.getElementById('grid');
const paletteEl = document.getElementById('palette');
const holesRange = document.getElementById('holes');
const holesVal = document.getElementById('holesVal');
const timeEl = document.getElementById('time');
const newBtn = document.getElementById('newBtn');
const restartBtn = document.getElementById('restartBtn');
const checkBtn = document.getElementById('checkBtn');
const modeSel = document.getElementById('mode');
const vol = document.getElementById('vol');
const muteBtn = document.getElementById('muteBtn');
const bgm = document.getElementById('bgm');

/* ---------------- BGM ---------------- */
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) bgm.pause(); else if(!bgm.muted) bgm.play(); });
vol.addEventListener('input', ()=>{ bgm.volume = +vol.value; if(bgm.volume>0) bgm.muted=false; });
muteBtn.addEventListener('click', ()=>{ bgm.muted = !bgm.muted; if(!bgm.muted && bgm.paused) bgm.play(); });

/* ---------------- åˆå§‹åŒ– UI ---------------- */
function buildBoard(){
  gridEl.innerHTML = '';
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      const d = document.createElement('div');
      d.className = 'cell';
      d.dataset.r = r; d.dataset.c = c;
      d.addEventListener('click', ()=> selectCell(d));
      gridEl.appendChild(d);
    }
  }
}
function selectCell(el){
  if(selectedCell) selectedCell.classList.remove('sel');
  selectedCell = el;
  selectedCell.classList.add('sel');
}

function renderPuzzle(){
  const cells = [...gridEl.children];
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      const i = r*9+c;
      const cell = cells[i];
      cell.innerHTML = '';
      const v = puzzle[r][c];
      if(v===0){
        // ç©ºç™½
      }else{
        // é¡¯ç¤ºç­”æ¡ˆå°æ‡‰å½±åƒï¼ˆè­œè™Ÿèˆ‡éŸ³åï¼‰
        const img = document.createElement('img');
        const arr = IMAGES[mode];
        // æˆ‘å€‘ç”¨ 1..9 å°æ‡‰ï¼š1=å›ºå®šé¡¯ç¤ºè©²èª¿çš„è­œè™Ÿã€2..9 å°æ‡‰ 8 å¼µå¡
        if(v===1){
          img.src = CLEF_IMG[mode];
        }else{
          const idx = v-2; // 0..7
          img.src = arr[idx]?.src || '';
        }
        cell.appendChild(img);
      }
    }
  }
}

/* ---------------- ç­”æ¡ˆæ¬„ï¼ˆæ£‹ç›¤èˆ‡è¨­å®šé¢æ¿ä¸­é–“ï¼‰ ---------------- */
function buildPalette(){
  paletteEl.innerHTML = '';
  // ç¬¬ä¸€å¼µï¼šè­œè™Ÿï¼ˆè®“ç©å®¶å¯æ”¾å…¥è­œè™Ÿçš„æ ¼å­ï¼Œå¦‚æœä½ ä¸éœ€è¦ï¼Œè¨»è§£æ‰é€™æ®µå³å¯ï¼‰
  const clefBox = document.createElement('div');
  clefBox.className = 'choice';
  const clefImg = document.createElement('img');
  clefImg.src = CLEF_IMG[mode];
  clefBox.appendChild(clefImg);
  clefBox.title = 'è­œè™Ÿ';
  clefBox.addEventListener('click', ()=> placeValue(1));
  paletteEl.appendChild(clefBox);

  // æ¥è‘— 8 å¼µéŸ³ç¬¦å¡ï¼ˆä¾ä½ æŒ‡å®šé †åºï¼‰
  for(let i=0;i<IMAGES[mode].length;i++){
    const box = document.createElement('div');
    box.className = 'choice';
    const img = document.createElement('img');
    img.src = IMAGES[mode][i].src;
    img.alt = IMAGES[mode][i].label;
    box.title = IMAGES[mode][i].label;
    box.appendChild(img);
    box.addEventListener('click', ()=> placeValue(i+2)); // 2..9
    paletteEl.appendChild(box);
  }
}

function placeValue(val){
  if(!selectedCell) return;
  const r = +selectedCell.dataset.r, c = +selectedCell.dataset.c;
  // åªå…è¨±ä¿®æ”¹åŸæœ¬æŒ–ç©ºçš„ä½ç½®
  if(initialMask[r][c]===0){
    puzzle[r][c] = val;
    renderPuzzle();
  }
}

/* ---------------- ç”¢ç”Ÿé¡Œç›®ï¼ˆç”±è§£ç­”æŒ–ç©ºï¼‰ ---------------- */
let initialMask = []; // 1=åŸé¡Œå›ºå®š, 0=å¯å¡«
function newPuzzle(){
  // åŸºæ–¼å›ºå®šè§£çš„ç°¡å–®æ‹·è²
  puzzle = SOLVE.map(row=>row.slice());
  // è½‰æˆ 1..9 çš„å°æ‡‰ï¼ˆ1=è­œè™Ÿï¼›2..9 å…«å¼µå¡ï¼‰
  // é€™è£¡åªç¤ºç¯„ï¼šæŠŠæ•¸å­— 1..9 ç›´æ¥ä¿ç•™ï¼Œè¦–è¦ºä¸Šæˆ‘å€‘ç”¨åœ–å¡ä»£æ›¿
  // â€”â€” ä½ ç¾æœ‰ç‰ˆæœ¬è‹¥å·²ç¶“å»ºç«‹æ˜ å°„ï¼Œä¿ç•™å³å¯
  const holes = +holesRange.value;
  initialMask = Array.from({length:9},()=>Array(9).fill(1));
  // éš¨æ©ŸæŒ–ç©º
  let removed = 0;
  const coords = [];
  for(let r=0;r<9;r++)for(let c=0;c<9;c++) coords.push([r,c]);
  coords.sort(()=>Math.random()-0.5);
  for(const [r,c] of coords){
    if(removed>=holes) break;
    puzzle[r][c] = 0;
    initialMask[r][c] = 0;
    removed++;
  }
  renderPuzzle();
  buildPalette();
  resetTimer(true);
}

/* ---------------- è¨ˆæ™‚ / æª¢æŸ¥ ---------------- */
function resetTimer(start=false){
  clearInterval(timerId);
  timeEl.textContent = '00:00';
  if(start){
    startMS = Date.now();
    timerId = setInterval(()=>{
      const s = Math.floor((Date.now()-startMS)/1000);
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      timeEl.textContent = `${mm}:${ss}`;
    }, 500);
  }
}
function checkFinished(){
  // è‹¥é‚„æœ‰ 0ï¼Œç›´æ¥æç¤ºæœªå®Œæˆ
  for(let r=0;r<9;r++) for(let c=0;c<9;c++){
    if(puzzle[r][c]===0){ alert('é‚„æœ‰ç©ºæ ¼å°šæœªå¡«å¯«å–”ï¼'); return; }
  }
  // ç°¡å–®æ¯”å°èˆ‡è§£ç­”ä¸€è‡´ï¼ˆç”¨ 1..9 æ¯”å°ï¼‰
  let ok = true;
  for(let r=0;r<9;r++) for(let c=0;c<9;c++){
    if(puzzle[r][c]!==SOLVE[r][c]) { ok=false; break; }
  }
  if(ok){
    confetti(); // æ­¡å‘¼
    alert('å…¨å°ï¼å¤ªæ£’äº†ï¼');
  }else{
    alert('æœ‰äº›æ ¼å­ä¸æ­£ç¢ºï¼Œå¯ä»¥å†æª¢æŸ¥ä¸€ä¸‹ï½');
  }
}

/* ---------------- UI ç¶å®š ---------------- */
holesRange.addEventListener('input', ()=>{
  holesVal.textContent = `${holesRange.value} æ ¼`;
});
newBtn.addEventListener('click', newPuzzle);
restartBtn.addEventListener('click', ()=>{ renderPuzzle(); resetTimer(true); });
checkBtn.addEventListener('click', checkFinished);
modeSel.addEventListener('change', ()=>{
  mode = modeSel.value;
  buildPalette();
  renderPuzzle(); // åªå½±éŸ¿é¡¯ç¤ºå½±åƒï¼Œä¸æ”¹è®Šæ—¢æœ‰æ•¸å­—ç‹€æ…‹
});

/* ---------------- å°å°æ­¡å‘¼ï¼ˆç´” JS ç‰ˆè¼•é‡ç´™èŠ±ï¼‰ ---------------- */
function confetti(){
  const n = 60;
  for(let i=0;i<n;i++){
    const s = document.createElement('div');
    s.style.position='fixed';
    s.style.left = (Math.random()*100)+'vw';
    s.style.top = '-10px';
    s.style.width = s.style.height = (6+Math.random()*6)+'px';
    s.style.background = `hsl(${Math.random()*360},90%,60%)`;
    s.style.opacity = '0.9';
    s.style.borderRadius = '2px';
    s.style.transform = `rotate(${Math.random()*360}deg)`;
    s.style.pointerEvents='none';
    s.style.zIndex=9999;
    document.body.appendChild(s);
    const dur = 1500 + Math.random()*1200;
    s.animate([
      { transform: s.style.transform+' translateY(0)' , opacity:1},
      { transform: s.style.transform+` translate(${(-50+Math.random()*100)}px, ${window.innerHeight+80}px)`, opacity:0.9}
    ], { duration: dur, easing:'cubic-bezier(.2,.7,.2,1)' }).onfinish = ()=> s.remove();
  }
}

/* ---------------- å•Ÿå‹• ---------------- */
buildBoard();
buildPalette();
newPuzzle();

/* å˜—è©¦è‡ªå‹•æ’­æ”¾ï¼ˆéƒ¨åˆ†ç€è¦½å™¨éœ€äº’å‹•å¾Œæ‰æœƒå‡ºè²ï¼‰ */
bgm.volume = +vol.value;
bgm.muted = false;
bgm.play().catch(()=>{ /* è‹¥è¢«é˜»æ“‹å°±ç­‰ä½¿ç”¨è€…äº’å‹• */ });

</script>
</body>
</html>
