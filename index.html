<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>音符數獨</title>
<style>
  :root{
    --board-size: 78vmin;        /* 棋盤邊長 */
    --gap: 16px;                  /* 區塊間間距 */
    --sidebar-w: 340px;           /* 右側設定寬度 */
    --palette-w: 140px;           /* 中間答案欄寬度（你要的位置） */
    --cell: calc(var(--board-size)/9);
    --bold: 4px;
    --thin: 1.5px;
    --ui-bg: #fff;
    --ui-shadow: 0 8px 24px rgba(0,0,0,.12);
  }

  body{
    margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
    background:#fafafa; color:#111; 
  }

  header{ text-align:center; padding:18px 12px 8px; font-weight:800; font-size: clamp(22px, 2.6vmin, 32px);}
  .page{
    display:grid;
    grid-template-columns: var(--board-size) var(--palette-w) var(--sidebar-w);
    justify-content:center;
    column-gap: var(--gap);
    row-gap: var(--gap);
    padding: 0 clamp(8px, 2vmin, 24px) 28px;
  }

  /* 棋盤 */
  .board{
    width: var(--board-size);
    height: var(--board-size);
    background:#fff;
    box-shadow: var(--ui-shadow);
    border: var(--bold) solid #111;
    position:relative;
  }
  .grid{
    position:absolute; inset:0; display:grid;
    grid-template-columns: repeat(9, 1fr);
    grid-template-rows: repeat(9, 1fr);
  }
  .cell{
    border: var(--thin) solid #111;
    position:relative; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
    background:#fff;
  }
  /* 九宮格粗線 */
  .cell:nth-child(3n+1){ /* 左粗線每列第一格另外處理在容器 */ }
  .grid > :nth-child(9n+1){ border-left: var(--bold) solid #111; }
  .grid > :nth-child(-n+9){ border-top: var(--bold) solid #111; }
  .grid > :nth-child(9n){ border-right: var(--bold) solid #111; }
  .grid > :nth-last-child(-n+9){ border-bottom: var(--bold) solid #111; }
  .grid > :nth-child(3n){ border-right: var(--bold) solid #111; }
  .grid > :nth-child(n+19):nth-child(-n+27),
  .grid > :nth-child(n+46):nth-child(-n+54){ border-bottom: var(--bold) solid #111; }

  .cell img{ width: 92%; height:auto; object-fit:contain; pointer-events:none; }

  /* 中間答案欄（你指定的位置） */
  .palette{
    width: var(--palette-w);
    height: var(--board-size);
    align-self:start;
    background: var(--ui-bg);
    box-shadow: var(--ui-shadow);
    border-radius: 12px;
    padding:10px;
    display:flex; flex-direction:column; gap:10px;
    overflow:auto;
  }
  .choice{
    background:#fff; border:1.5px solid #111; border-radius:10px;
    padding:6px; display:flex; align-items:center; justify-content:center;
    cursor:pointer; transition: transform .06s ease;
    aspect-ratio: 1 / 1;
  }
  .choice:hover{ transform: translateY(-1px); }
  .choice img{ width: 100%; height:auto; object-fit:contain; }

  /* 右側設定卡 */
  .panel{
    width: var(--sidebar-w);
    background:var(--ui-bg);
    box-shadow: var(--ui-shadow);
    border-radius:14px; padding:18px 18px;
    align-self:start;
  }
  .panel h3{ margin:0 0 10px; font-size:18px;}
  .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:12px 0;}
  .panel button, .panel select{
    border:1px solid #ddd; background:#fff; border-radius:8px; padding:8px 10px; cursor:pointer;
  }
  .panel button.primary{ background:#28a745; color:#fff; border:0; }
  .muted{ opacity:.6}
  .note{ font-size:12px; color:#666; text-align:center; margin-top:12px; }

  /* 選擇格高亮 */
  .cell.sel{ outline: 3px solid #3b82f6; outline-offset:-3px; }

  /* 底部署名 */
  footer{ text-align:center; font-size:12px; color:#555; margin-top:8px; }
  footer a{ color:#1d4ed8; text-decoration:none; }

  /* 小螢幕：把 palette 收到棋盤下方（仍不遮住棋盤） */
  @media (max-width: 1024px){
    :root{ --sidebar-w: 310px; --palette-w: 118px; }
    .page{ grid-template-columns: minmax(290px, var(--board-size)) var(--palette-w) var(--sidebar-w); }
  }
  @media (max-width: 860px){
    :root{ --board-size: 92vmin; }
    .page{ grid-template-columns: 1fr; }
    .palette, .panel{ width: min(560px, 94%); justify-self:center; }
    .palette{ height: auto; max-height: 36vh; order: 2; }
    .panel{ order:3; }
    .board{ justify-self:center; order:1; }
  }
</style>
</head>
<body>

<header>音符數獨</header>

<main class="page">
  <!-- 棋盤 -->
  <section class="board" id="board">
    <div class="grid" id="grid"></div>
  </section>

  <!-- 中間答案欄（位於棋盤與設定中間） -->
  <aside class="palette" id="palette"></aside>

  <!-- 設定面板 -->
  <aside class="panel">
    <h3>設定</h3>

    <div class="row">
      <span>困難度（挖空格數）</span>
      <input id="holes" type="range" min="0" max="40" value="32" />
      <span id="holesVal">32 格</span>
    </div>

    <div class="row">
      <span>時間</span>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="newBtn">新題目</button>
        <button id="restartBtn">重新開始</button>
        <span id="time">00:00</span>
      </div>
    </div>

    <div class="row">
      <span>音量</span>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.5" />
        <button id="muteBtn">🔇 靜音/取消</button>
      </div>
    </div>

    <div class="row">
      <span>模式：</span>
      <select id="mode">
        <option value="treble">高音區域</option>
        <option value="bass">低音區域</option>
      </select>
    </div>

    <div class="row">
      <button id="checkBtn" class="primary">已完成填寫</button>
    </div>
    <div class="note">完成後可檢查，正確會歡呼！</div>
  </aside>
</main>

<footer>
  Music: "Danse Morialta" Kevin MacLeod (incompetech.com) · Licensed under Creative Commons: By Attribution 4.0 License ·
  <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">http://creativecommons.org/licenses/by/4.0/</a>
</footer>

<audio id="bgm" src="audio/bgm.mp3" preload="auto" loop autoplay></audio>

<script>
/* ---------------- 資料：影像清單（依你要求的順序） ---------------- */
const IMAGES = {
  treble: [
    {key:'c_low',  src:'assets/高音譜號下加一線do五線譜.png', label:'下加一線do'},
    {key:'d',      src:'assets/高音譜號下一間re五線譜.png',   label:'re'},
    {key:'e',      src:'assets/高音譜號第一線mi五線譜.png',   label:'mi'},
    {key:'f',      src:'assets/高音譜號第一間fa五線譜.png',   label:'fa'},
    {key:'g',      src:'assets/高音譜號第二線sol五線譜.png',  label:'sol'},
    {key:'a',      src:'assets/高音譜號第二間la五線譜.png',   label:'la'},
    {key:'b',      src:'assets/高音譜號第三線si五線譜.png',   label:'si'},
    {key:'c_hi',   src:'assets/高音譜號第三間do五線譜.png',   label:'第三間do'}
  ],
  bass: [
    {key:'c',      src:'assets/低音譜號第二間do五線譜.png',   label:'第二間do'},
    {key:'d',      src:'assets/低音譜號第三線re五線譜.png',   label:'re'},
    {key:'e',      src:'assets/低音譜號第三間mi五線譜.png',   label:'mi'},
    {key:'f',      src:'assets/低音譜號第四線fa五線譜.png',   label:'fa'},
    {key:'g',      src:'assets/低音譜號第四間sol五線譜.png',  label:'sol'},
    {key:'a',      src:'assets/低音譜號第五線la五線譜.png',   label:'la'},
    {key:'b',      src:'assets/低音譜號上加一間si五線譜.png', label:'si'},
    {key:'c_up',   src:'assets/低音譜號上加一線do五線譜.png', label:'上加一線do'}
  ]
};
// 版面上固定顯示譜號作為第一張（非可填入的答案）
const CLEF_IMG = {
  treble: 'assets/高音譜號.png',
  bass:   'assets/低音譜號.png'
};

/* ---------------- 棋盤/題目（簡化範例：藍本解 + 挖空） ---------------- */
// 固定解（9x9 1..9）；你可換成自己的題庫產生器
const SOLVE = [
  [5,3,4,6,7,8,9,1,2],
  [6,7,2,1,9,5,3,4,8],
  [1,9,8,3,4,2,5,6,7],
  [8,5,9,7,6,1,4,2,3],
  [4,2,6,8,5,3,7,9,1],
  [7,1,3,9,2,4,8,5,6],
  [9,6,1,5,3,7,2,8,4],
  [2,8,7,4,1,9,6,3,5],
  [3,4,5,2,8,6,1,7,9]
];
let puzzle = [];
let mode = 'treble';
let startMS = 0, timerId = null;
let selectedCell = null;

const gridEl = document.getElementById('grid');
const paletteEl = document.getElementById('palette');
const holesRange = document.getElementById('holes');
const holesVal = document.getElementById('holesVal');
const timeEl = document.getElementById('time');
const newBtn = document.getElementById('newBtn');
const restartBtn = document.getElementById('restartBtn');
const checkBtn = document.getElementById('checkBtn');
const modeSel = document.getElementById('mode');
const vol = document.getElementById('vol');
const muteBtn = document.getElementById('muteBtn');
const bgm = document.getElementById('bgm');

/* ---------------- BGM ---------------- */
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) bgm.pause(); else if(!bgm.muted) bgm.play(); });
vol.addEventListener('input', ()=>{ bgm.volume = +vol.value; if(bgm.volume>0) bgm.muted=false; });
muteBtn.addEventListener('click', ()=>{ bgm.muted = !bgm.muted; if(!bgm.muted && bgm.paused) bgm.play(); });

/* ---------------- 初始化 UI ---------------- */
function buildBoard(){
  gridEl.innerHTML = '';
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      const d = document.createElement('div');
      d.className = 'cell';
      d.dataset.r = r; d.dataset.c = c;
      d.addEventListener('click', ()=> selectCell(d));
      gridEl.appendChild(d);
    }
  }
}
function selectCell(el){
  if(selectedCell) selectedCell.classList.remove('sel');
  selectedCell = el;
  selectedCell.classList.add('sel');
}

function renderPuzzle(){
  const cells = [...gridEl.children];
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      const i = r*9+c;
      const cell = cells[i];
      cell.innerHTML = '';
      const v = puzzle[r][c];
      if(v===0){
        // 空白
      }else{
        // 顯示答案對應影像（譜號與音名）
        const img = document.createElement('img');
        const arr = IMAGES[mode];
        // 我們用 1..9 對應：1=固定顯示該調的譜號、2..9 對應 8 張卡
        if(v===1){
          img.src = CLEF_IMG[mode];
        }else{
          const idx = v-2; // 0..7
          img.src = arr[idx]?.src || '';
        }
        cell.appendChild(img);
      }
    }
  }
}

/* ---------------- 答案欄（棋盤與設定面板中間） ---------------- */
function buildPalette(){
  paletteEl.innerHTML = '';
  // 第一張：譜號（讓玩家可放入譜號的格子，如果你不需要，註解掉這段即可）
  const clefBox = document.createElement('div');
  clefBox.className = 'choice';
  const clefImg = document.createElement('img');
  clefImg.src = CLEF_IMG[mode];
  clefBox.appendChild(clefImg);
  clefBox.title = '譜號';
  clefBox.addEventListener('click', ()=> placeValue(1));
  paletteEl.appendChild(clefBox);

  // 接著 8 張音符卡（依你指定順序）
  for(let i=0;i<IMAGES[mode].length;i++){
    const box = document.createElement('div');
    box.className = 'choice';
    const img = document.createElement('img');
    img.src = IMAGES[mode][i].src;
    img.alt = IMAGES[mode][i].label;
    box.title = IMAGES[mode][i].label;
    box.appendChild(img);
    box.addEventListener('click', ()=> placeValue(i+2)); // 2..9
    paletteEl.appendChild(box);
  }
}

function placeValue(val){
  if(!selectedCell) return;
  const r = +selectedCell.dataset.r, c = +selectedCell.dataset.c;
  // 只允許修改原本挖空的位置
  if(initialMask[r][c]===0){
    puzzle[r][c] = val;
    renderPuzzle();
  }
}

/* ---------------- 產生題目（由解答挖空） ---------------- */
let initialMask = []; // 1=原題固定, 0=可填
function newPuzzle(){
  // 基於固定解的簡單拷貝
  puzzle = SOLVE.map(row=>row.slice());
  // 轉成 1..9 的對應（1=譜號；2..9 八張卡）
  // 這裡只示範：把數字 1..9 直接保留，視覺上我們用圖卡代替
  // —— 你現有版本若已經建立映射，保留即可
  const holes = +holesRange.value;
  initialMask = Array.from({length:9},()=>Array(9).fill(1));
  // 隨機挖空
  let removed = 0;
  const coords = [];
  for(let r=0;r<9;r++)for(let c=0;c<9;c++) coords.push([r,c]);
  coords.sort(()=>Math.random()-0.5);
  for(const [r,c] of coords){
    if(removed>=holes) break;
    puzzle[r][c] = 0;
    initialMask[r][c] = 0;
    removed++;
  }
  renderPuzzle();
  buildPalette();
  resetTimer(true);
}

/* ---------------- 計時 / 檢查 ---------------- */
function resetTimer(start=false){
  clearInterval(timerId);
  timeEl.textContent = '00:00';
  if(start){
    startMS = Date.now();
    timerId = setInterval(()=>{
      const s = Math.floor((Date.now()-startMS)/1000);
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      timeEl.textContent = `${mm}:${ss}`;
    }, 500);
  }
}
function checkFinished(){
  // 若還有 0，直接提示未完成
  for(let r=0;r<9;r++) for(let c=0;c<9;c++){
    if(puzzle[r][c]===0){ alert('還有空格尚未填寫喔！'); return; }
  }
  // 簡單比對與解答一致（用 1..9 比對）
  let ok = true;
  for(let r=0;r<9;r++) for(let c=0;c<9;c++){
    if(puzzle[r][c]!==SOLVE[r][c]) { ok=false; break; }
  }
  if(ok){
    confetti(); // 歡呼
    alert('全對！太棒了！');
  }else{
    alert('有些格子不正確，可以再檢查一下～');
  }
}

/* ---------------- UI 綁定 ---------------- */
holesRange.addEventListener('input', ()=>{
  holesVal.textContent = `${holesRange.value} 格`;
});
newBtn.addEventListener('click', newPuzzle);
restartBtn.addEventListener('click', ()=>{ renderPuzzle(); resetTimer(true); });
checkBtn.addEventListener('click', checkFinished);
modeSel.addEventListener('change', ()=>{
  mode = modeSel.value;
  buildPalette();
  renderPuzzle(); // 只影響顯示影像，不改變既有數字狀態
});

/* ---------------- 小小歡呼（純 JS 版輕量紙花） ---------------- */
function confetti(){
  const n = 60;
  for(let i=0;i<n;i++){
    const s = document.createElement('div');
    s.style.position='fixed';
    s.style.left = (Math.random()*100)+'vw';
    s.style.top = '-10px';
    s.style.width = s.style.height = (6+Math.random()*6)+'px';
    s.style.background = `hsl(${Math.random()*360},90%,60%)`;
    s.style.opacity = '0.9';
    s.style.borderRadius = '2px';
    s.style.transform = `rotate(${Math.random()*360}deg)`;
    s.style.pointerEvents='none';
    s.style.zIndex=9999;
    document.body.appendChild(s);
    const dur = 1500 + Math.random()*1200;
    s.animate([
      { transform: s.style.transform+' translateY(0)' , opacity:1},
      { transform: s.style.transform+` translate(${(-50+Math.random()*100)}px, ${window.innerHeight+80}px)`, opacity:0.9}
    ], { duration: dur, easing:'cubic-bezier(.2,.7,.2,1)' }).onfinish = ()=> s.remove();
  }
}

/* ---------------- 啟動 ---------------- */
buildBoard();
buildPalette();
newPuzzle();

/* 嘗試自動播放（部分瀏覽器需互動後才會出聲） */
bgm.volume = +vol.value;
bgm.muted = false;
bgm.play().catch(()=>{ /* 若被阻擋就等使用者互動 */ });

</script>
</body>
</html>
